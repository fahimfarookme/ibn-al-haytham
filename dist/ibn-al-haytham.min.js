/**
 * Ibn Al-Haytham - the customizable calendar.
 *
 * @author Fahim Farook
 */

if (typeof HAYTHAM === "undefined" || !HAYTHAM) {
   /**
    * The HAYTHAM global namespace object.  If HAYTHAM is already defined, the
    * existing HAYTHAM object will not be overwritten so that defined
    * namespaces are preserved.
    */
   var HAYTHAM = {};
}
/**
 * The pulic api exposed.
 *
 * @author Fahim Farook
 */
;(function($, haytham) {

   "user strict";

   /**
    * The module which is attached to element.
    * 
    * @param  {element} element The element on which the pligin is invoked.
    * @param  {object}  options The optional settings.
    * @return {void}
    */
   var api = function(options) {
      this.options = $.extend(true, {}, haytham.defaults, options);
      this.template = new haytham.template(this.options);
   };

   api.prototype = {
      constructor: api,

      generate: function(year, month) {
         return this.template.generate(year, month);
      }
   }

   haytham.api = api;

})(jQuery, HAYTHAM || {});
/**
 * The default options.
 *
 * @author Fahim Farook
 */
;
(function($, haytham) {

   "user strict";

   var now = new Date();

   haytham.defaults = {
      month: {
         start: now.getMonth(),
         long: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
         short: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
         display: "long"
      },
      week: {
         start: 1, // 0 - Sunday, 1 - Monday...
         long: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
         short: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
         display: "short"
      },
      year: now.getFullYear(),
      events: {
         clickDate: {
            name: "click.haytham",
            selector: ".day",
            handler: null
         }
      },
      data: {
         // "MM-DD-YYYY" : "HTML Content",
         // "MM-DD-YYYY" : "HTML Content",
         // "MM-DD-YYYY" : "HTML Content"
      }
   };

})(jQuery, HAYTHAM || {});
/**
 * Binds events with the calendar.
 *
 * @author Fahim Farook
 */
;
(function($, haytham) {

   "user strict";

   var util = function(data, options) {
      this.options = options;
      this.data = data ? data : {};
   };

   util.prototype = {
      constructor: util,

      year: function() {
         return this.data.year;
      },

      month: function() {
         return this.data.month;
      },

      monthName: function() {
         return this.options.month.long[this.data.month];
      },

      monthNameShort: function() {
         return this.options.month.short[this.data.month];
      },

      dayOfMonth: function() {
         return this.data.dayOfMonth;
      },

      dayOfWeek: function() {
         return this.data.dayOfWeek;
      },

      dayName: function() {
         var index = this.data.dayOfWeek + this.options.week.start;
         index = index > 6 ? index - 7 : index;
         return this.options.week.long[index];
      },

      dayNameShort: function() {
         var index = this.data.dayOfWeek + this.options.week.start;
         index = index > 6 ? index - 7 : index;
         return this.options.week.short[index];
      }
   };

   var event = function(options) {
      this.options = options;
      this.events = options.events;
   };

   event.prototype = {
      constructor: event,

      bind: function(template) {
         for (var key in this.events) {
            if (this.events.hasOwnProperty(key)) {
               var event = this.events[key];
               if (typeof event === "function") {
                  event = haytham.defaults.events[key];
                  event.handler = this.events[key];
               }
               template.on(event.name, event.selector, this._handler(event.handler, this.options));
            }
         }
         return template;
      },

      unbind: function(template) {
         for (var key in this.events) {
            if (this.events.hasOwnProperty(key)) {
               var event = this.events[key];
               template.off(event.name);
            }
         }
         return template;
      },

      _handler: function(handler, options) {
         return function(event) {
            event.stopPropagation();
            var data = new util($(this).data(), options);

            if (typeof handler === "function") {
               return handler(data);
            }

            return data;
         };

      }

   };

   haytham.event = event;

})(jQuery, HAYTHAM || {});

/**
 * Template generator for Ibn Al-Haytham calendar.
 * Credits
 * - http://jszen.blogspot.pt/2007/03/how-to-build-simple-calendar-with.html.
 * - https://tympanus.net/Development/Calendario/index2.html
 *
 * @author Fahim Farook
 */
;
(function($, haytham) {

   "user strict";

   var MAX_WEEKS_PER_MONTH = 6,

      MAX_DAYS_PER_WEEK = 7,

      structure = (
         "<div class='iah-datepicker iah-rows-n>" +
            "<div class='head'>" +
               "<div class='month'></div>" +
               "<div class='year'></div>" +
            "</div>" +
            "<div class='body'>" +
               "<div class='week-header'></div>" +
               "<div class='week'>" +
                  "<span class='day' data-date='DD-MM-YYYY', data-data='{}'></span>" +
               "</div>" +
            "</div>" +
         "</div>"
      ),

      numWeeks = function(body) {
         return body.find(".week").size();
      };

   /**
    * The calendar template - generates calendar elements.
    * @return {element} calendar
    */
   var template = function(options) {
      this.options = options;
      this.event = new haytham.event(options);
   };

   template.prototype = {
      constructor: template,

      /**
       * Gnerates the html calendar for a given month. Also binds events on calendar.
       * @param  {integer} year  The year.
       * @param  {integer} month The month.
       * @return {element}       Generated html element.
       */
      generate: function(year, month) {
         var head = this._generateHead(year, month);
         var body = this._generateBody(year, month);
         var cal = $("<div class='iah-datepicker " + "iah-weeks-" + numWeeks(body) + "'>").append(head, body);
         return this.event.bind(cal);
      },

      /**
       * Generates the week header - which is static for all the calendars/ months.
       * @return {element} The <div class='week-header'> element.
       */
      _generateWeekHeader: function() {
         var html = "";
         for (var i = 0; i < 7; i++) {
            var index = i + this.options.week.start;
            index = index > 6 ? index - 7 : index;

            html += "<div>";
            html += this.options.week[this.options.week.display][index];
            html += "</div>";
         }

         return html;
      },


      /**
       * Generates the head section of the calendar.
       * <div class='head'>
       *    <div class='month'></div>
       *    <div class='year'></div>
       * </div>
       * 
       * @param  {integer} year  The year.
       * @param  {integer} month The month.
       * @return {element}       Generated html element.
       */
      _generateHead: function(year, month) {
         return $("<div class='head'>").append(
            $("<div class='month'>" + this.options.month[this.options.month.display][month] + "</div>"),
            $("<div class='year'>" + year + "</div>"));
      },

      /**
       * Generates the body section of the calendar.
       * <div class='body'>
       *    <div class='week-header'></div>
       *    <div class='week'></div>
       * </div>
       * 
       * @param  {integer} year  The year.
       * @param  {integer} month The month.
       * @return {element}       Generated html element.
       */
      _generateBody: function(year, month) {
         var $weekHeader = $("<div class='week-header'>").append(this._generateWeekHeader());
         // new Date(year, month, 1).getDay() = first day of first week
         // new Date(year, month + 1, 0).getDate() = last day ofmonth  
         var diff = new Date(year, month, 1).getDay() - this.options.week.start;
         var firstDayOfFirstWeek = diff < 0 ? diff + MAX_DAYS_PER_WEEK : diff;

         var data = {
            year: year,
            month: month,
            week: 1, // starts at 1
            dayOfMonth: 1, // starts at 1
            lastDayOfMonth: new Date(year, month + 1, 0).getDate(),
            firstDayOfFirstWeek: firstDayOfFirstWeek
         };

         return $("<div class='body'>").append($weekHeader, this._generateWeeks(data.week, data));
      },

      /**
       * Generates weeks array, recursively.
       * <div class='week'></div>
       * <div class='week'></div>
       * <div class='week'></div>
       * <div class='week'></div>
       * 
       * @param  {integer} week  The week. 1 -> first week.
       * @param  {object}  data  The data having rest of the details. dayOfMonth, lastDayOfMonth
       * @return {element}       Generated html elements.
       */
      _generateWeeks: function(week, data) {
         // exit conditions
         // if week exceeded 6
         // if day of month exceeded last day of month.
         if (week > MAX_WEEKS_PER_MONTH || data.dayOfMonth > data.lastDayOfMonth) {
            return;
         }
         var $curr = $("<div class='week'>").append(this._generateDaysOfWeek(0, data));
         ++data.week;
         return $curr.after(this._generateWeeks(data.week, data));
      },

      /**
       * Generates days array for the given week, recursively.
       * <div></div>
       * <div></div>
       * <div></div>
       * <div></div>
       * <div></div>
       * <div></div>
       * <div></div>
       * 
       * @param  {integer} dayOfWeek   The day of the week.
       * @param  {object}  data        The data having rest of the details.
       * @return {element}             Generated html elements.
       */
      _generateDaysOfWeek: function(dayOfWeek, data) {
         // exit conditions
         // if day of week exceeded 7
         if (dayOfWeek >= MAX_DAYS_PER_WEEK) {
            return;
         }

         var $curr = $("<div class='day'>");
         // day of month - not exceeded the last day of month
         // not first week -OR- Or first day of of (first week) is reached
         if (data.dayOfMonth <= data.lastDayOfMonth && (data.week > 1 || dayOfWeek >= data.firstDayOfFirstWeek)) {
            var dayStr = data.year + "-" + (data.month < 10 ? "0" + data.month : data.month) + "-" + (data.dayOfMonth < 10 ? "0" + data.dayOfMonth : data.dayOfMonth);
            $curr.append(data.dayOfMonth);
            $curr.data("dayOfWeek", dayOfWeek);
            $curr.data("dayOfMonth", data.dayOfMonth);
            $curr.data("month", data.month);
            $curr.data("year", data.year);
            $curr.data("data", this.options.data[dayStr]);
            ++data.dayOfMonth;
         }

         return $curr.after(this._generateDaysOfWeek(++dayOfWeek, data));
      }
   };

   haytham.template = template;

})(jQuery, HAYTHAM || {});
/**
 * The jquery plugin.
 *
 * @author Fahim Farook
 */
;(function($, api) {

   "user strict";

   var NAMESPACE = "haytham",

      decorate = function(mod, element) {
         var fn = mod.generate;
         mod.generate = function(year, month) {
            $(element).append(fn.call(mod, year, month));
         }
         return mod;
      };

   // Register as a jquery plugin
   // jQuery.fn = jQuery.prototype
   $.fn.haytham = function(options) {
      var result = [];

      // this.each - to instantiate multiple calendars for multiple selected elements.
      this.each(function() {
         var mod = $(this).data(NAMESPACE);
         if (!mod) { // if not already instantiated
            mod = decorate(new api(options), this);
            $(this).addClass("iah-datepicker-container");
            $(this).data(NAMESPACE, mod);
         }
         result.push(mod);
      });

      return result.length > 1 ? result : result[0];
   };

})(jQuery, HAYTHAM.api);
